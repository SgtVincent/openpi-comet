# RFT Data Generation

This directory contains scripts to convert raw rollout data collected from experiments into the RFT (Robot Fine-Tuning) dataset format. The pipeline consists of two main steps: indexing the rollouts and converting the data.

## Scripts

### 1. `generate_rft_index.py`

This script scans a directory of collected rollouts, identifies valid runs, and assigns unique episode IDs mapped to specific tasks. It produces a JSONL index file that is used by the conversion script.

**Key Features:**

- Scans for valid runs (checks for `state_action.npz`).
- Maps experiment directories to task names using `cfg*.out` files.
- Assigns episode IDs based on task indices.
- Supports incremental updates (appends to existing JSONL files without duplicating entries).

**Usage:**

```bash
python data_generation/rft/generate_rft_index.py \
  <rollouts_root_dir> \
  <output_jsonl_path> \
  --tasks_jsonl <path_to_tasks_jsonl>
```

**Arguments:**

- `root_dir`: Root directory containing the rollout data (e.g., organized by date/experiment).
- `output_jsonl`: Path where the generated index JSONL file will be saved.
- `--tasks_jsonl`: Path to the `tasks.jsonl` file containing task name to index mappings (default: `2025-challenge-demos/meta/tasks.jsonl`).

### 2. `convert_rft_data.py`

This script takes the index generated by `generate_rft_index.py` and processes the raw data into the final dataset format. It handles data conversion, video trimming, and metadata synchronization.

**Key Features:**

- Converts `state_action.npz` data to Parquet format.
- Trims the first 20 frames (static frames) from states, actions, and videos.
- Updates metadata and annotations based on a template dataset (e.g., BEHAVIOR demos).
- Trims videos using `ffmpeg`.
- Supports parallel processing for faster conversion.

**Usage:**

```bash
python data_generation/rft/convert_rft_data.py \
  --input-root <rollouts_root_dir> \
  --output-root <output_dataset_root> \
  --jsonl <generated_index_jsonl> \
  --tasks-jsonl <path_to_tasks_jsonl> \
  --template-root <path_to_template_dataset>
```

**Arguments:**

- `--input-root`: The same root directory used in generation (local path).
- `--output-root`: Directory where the converted dataset will be saved.
- `--jsonl`: The index file generated by `generate_rft_index.py`.
- `--tasks-jsonl`: Path to `tasks.jsonl` (default: `2025-challenge-demos/meta/tasks.jsonl`).
- `--template-root`: Path to an existing dataset (e.g., `2025-challenge-demos`) to copy meta/annotation templates from.
- `--num-workers`: Number of parallel workers (default: 32).
- `--no-skip-existing`: Flag to force reprocessing of existing outputs.

## Workflow Example

1. **Generate the Index**:

   Identify all valid rollouts and assign IDs.

   ```bash
   python data_generation/rft/generate_rft_index.py \
     ./data/raw_rollouts \
     ./data/indices/rollouts_v1.jsonl \
     --tasks_jsonl ./data/meta/tasks.jsonl
   ```

2. **Convert the Data**:

   Process the indexed rollouts into the final format.

   ```bash
   python data_generation/rft/convert_rft_data.py \
     --input-root ./data/raw_rollouts \
     --output-root ./data/processed_dataset \
     --jsonl ./data/indices/rollouts_v1.jsonl \
     --tasks-jsonl ./data/meta/tasks.jsonl \
     --template-root ./data/2025-challenge-demos
   ```
